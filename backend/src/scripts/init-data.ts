import type { KVNamespace } from '@cloudflare/workers-types'

export interface ChapterData {
  chapter_id: string
  title: string
  description: string
  content: string
  simple_explanation: string
  examples: string[]
  category: 'micro' | 'macro' | 'finance'
  difficulty: 'beginner' | 'intermediate' | 'advanced'
  order: number
  is_published: boolean
  related_charts?: string[]
}

const initialChapters: Omit<ChapterData, 'is_published'>[] = [
  {
    chapter_id: 'supply-demand-basics',
    title: '供需关系基础',
    description: '理解经济学中最基本的概念——供给与需求如何决定市场价格',
    content: `
# 供需关系基础

## 什么是需求？

需求是指消费者在一定时间内，在各种可能的价格水平下，愿意并且能够购买的商品或服务数量。

**需求定律**：在其他条件不变的情况下，价格越高，需求量越少；价格越低，需求量越多。

## 什么是供给？

供给是指生产者在一定时间内，在各种可能的价格水平下，愿意并且能够提供的商品或服务数量。

**供给定律**：在其他条件不变的情况下，价格越高，供给量越多；价格越低，供给量越少。

## 市场均衡

当供给量和需求量相等时，市场达到均衡状态，此时的价格称为**均衡价格**。

### 均衡的形成过程

- 当价格高于均衡价格时：供给过剩，价格下降
- 当价格低于均衡价格时：需求过剩，价格上升
- 最终价格会稳定在均衡点
    `,
    simple_explanation: '就像菜市场买菜，菜贵了买的人少，菜便宜了买的人多。卖菜的人也是这样，菜贵了愿意多卖，菜便宜了就想少卖点。最后买卖双方会达成一个双方都接受的价格。',
    examples: [
      '疫情期间口罩价格飞涨——需求激增导致价格上涨',
      '水果季节性价格变化——供应旺季价格下降',
      '演唱会门票黄牛现象——需求超过供给导致价格飙升'
    ],
    category: 'micro',
    difficulty: 'beginner',
    order: 1,
    related_charts: ['supply-demand-curve', 'price-equilibrium']
  },
  {
    chapter_id: 'elasticity-basics',
    title: '弹性理论入门',
    description: '学习如何衡量消费者和生产者对价格变化的敏感程度',
    content: `
# 弹性理论入门

## 什么是弹性？

弹性衡量的是一个变量对另一个变量变化的反应程度。在经济学中，最常用的是**价格弹性**。

## 需求价格弹性

需求价格弹性衡量需求量对价格变化的反应程度。

**计算公式**：
$$E_d = \\frac{\\text{需求量变化百分比}}{\\text{价格变化百分比}}$$

### 弹性类型

- **富有弹性**（|Ed| > 1）：需求量变化大于价格变化
  - 例：奢侈品、可替代品多的商品

- **缺乏弹性**（|Ed| < 1）：需求量变化小于价格变化
  - 例：必需品、成瘾物品

- **单位弹性**（|Ed| = 1）：需求量变化等于价格变化
  - 例：某些特定情况下的商品

## 供给价格弹性

供给价格弹性衡量供给量对价格变化的反应程度。

### 影响供给弹性的因素

- **生产周期**：周期越长，弹性越大
- **生产成本**：成本递增越快，弹性越小
- **生产要素**：要素越容易获得，弹性越大
    `,
    simple_explanation: '弹性就是"敏感度"。如果价格稍微涨一点，大家就不买了，说明需求很敏感（弹性大）。如果价格涨了很多，大家还是照买不误，说明需求不敏感（弹性小）。',
    examples: [
      '盐的价格弹性很低——必需品，无可替代',
      '名牌包的价格弹性较高——奢侈品，可替代',
      '航空机票价格弹性——商务出行弹性低，旅游出行弹性高'
    ],
    category: 'micro',
    difficulty: 'intermediate',
    order: 2,
    related_charts: ['supply-demand-curve']
  },
  {
    chapter_id: 'market-failure',
    title: '市场失灵',
    description: '了解市场机制为什么会失效，以及政府干预的必要性',
    content: `
# 市场失灵

## 什么是市场失灵？

市场失灵是指市场机制本身无法有效配置资源的情况。即使完全竞争市场，也可能出现失灵。

## 市场失灵的类型

### 1. 外部性

**正外部性**：行为给第三方带来收益
- 例：教育、疫苗接种、研发

**负外部性**：行为给第三方带来成本
- 例：污染、噪音、交通拥堵

### 2. 公共物品

**特点**：
- 非竞争性：一人使用不影响他人使用
- 非排他性：无法阻止他人使用

**例子**：
- 国防、路灯、公共卫生

### 3. 信息不对称

一方比另一方拥有更多信息，导致市场失灵。

**例子**：
- 二手车市场（柠檬问题）
- 医疗服务
- 保险市场

### 4. 垄断

单个或少数企业控制市场，导致：
- 价格高于竞争水平
- 产量低于竞争水平
- 效率损失

## 政府干预方式

- **税收**：纠正负外部性
- **补贴**：鼓励正外部性
- **管制**：直接干预市场行为
- **公有化**：提供公共物品
    `,
    simple_explanation: '市场不是万能的。有时候它会"搞砸"——比如工厂污染环境但不愿治理（负外部性），或者没有人愿意修路但大家都需要路（公共物品）。这时候就需要政府出面纠正。',
    examples: [
      '工厂排污不加处理——负外部性，需要环保税',
      '疫苗接种——正外部性，政府提供补贴',
      '路灯建设——公共物品，必须由政府提供',
      '垄断企业定价——需要反垄断监管'
    ],
    category: 'micro',
    difficulty: 'advanced',
    order: 3,
    related_charts: ['externalities']
  },
  {
    chapter_id: 'gdp-basics',
    title: 'GDP 与经济增长',
    description: '理解国内生产总值的含义及其在衡量经济中的作用',
    content: `
# GDP 与经济增长

## 什么是 GDP？

**国内生产总值（GDP）**是一个国家在一定时期内生产的所有最终产品和服务的市场价值。

### GDP 的特点

1. **地域概念**：只要在本国境内生产，无论本国公民还是外国公民
2. **时期概念**：一定时期（通常是一年或一季度）的生产
3. **最终产品**：不计入中间产品，避免重复计算
4. **市场价值**：通过市场交易的价值

## GDP 的计算方法

### 支出法（最常用）

$$GDP = C + I + G + NX$$

- **C（消费）**：居民消费支出
- **I（投资）**：企业投资支出
- **G（政府购买）**：政府支出
- **NX（净出口）**：出口 - 进口

## GDP 的局限性

### GDP 不包括的内容

- 家庭劳动（做饭、带孩子等）
- 地下经济
- 闲暇时间
- 环境质量
- 收入分配

### 人均 GDP

$$\\text{人均GDP} = \\frac{\\text{GDP}}{\\text{人口总数}}$$

更准确地反映平均生活水平。

## 经济增长

经济增长通常用 GDP 增长率衡量：

$$\\text{GDP增长率} = \\frac{\\text{本年GDP} - \\text{上年GDP}}{\\text{上年GDP}} \\times 100\\%$$

### 经济增长的源泉

- **资本积累**：更多生产资料
- **技术进步**：更有效率的生产方式
- **人力资本**：教育和技能提升
- **制度改善**：更好的产权保护、法治环境
    `,
    simple_explanation: 'GDP 就像一个国家的"年度总收入"，算的是这一年大家生产了多少有价值的东西和服务。但 GDP 有缺点——比如妈妈在家做家务不算 GDP，但在餐厅吃饭就算，这显然不太合理。',
    examples: [
      '中国 GDP 超过日本成为世界第二',
      '疫情期间 GDP 下降——经济衰退',
      '服务业占比上升——经济结构转型',
      '印度 GDP 增长快但人均低——人口基数大'
    ],
    category: 'macro',
    difficulty: 'beginner',
    order: 4,
    related_charts: ['inflation-chart']
  },
  {
    chapter_id: 'inflation-basics',
    title: '通货膨胀',
    description: '了解物价持续上涨的原因和影响',
    content: `
# 通货膨胀

## 什么是通货膨胀？

通货膨胀是指物价水平持续、普遍上涨的经济现象，货币购买力下降。

### 衡量指标

**消费者价格指数（CPI）**：反映居民家庭购买的消费品和服务价格变动程度

$$\\text{CPI} = \\frac{\\text{当期篮子价格}}{\\text{基期篮子价格}} \\times 100$$

## 通货膨胀的类型

### 按程度分类

- **温和通胀**（< 10%）：有利于经济增长
- **奔腾通胀**（10% - 100%）：经济不稳定
- **恶性通胀**（> 100%%）：经济崩溃

### 按原因分类

1. **需求拉动型**：总需求超过总供给
   - "太多货币追逐太少的商品"

2. **成本推动型**：生产成本上升
   - 工资上涨、原材料涨价

3. **结构性**：经济结构变化
   - 部门发展不平衡

## 通货膨胀的影响

### 负面影响

- **财富再分配**：债权人受损，债务人受益
- **收入再分配**：固定收入者受损
- **不确定性增加**：投资和消费决策困难

### 正面影响

- **温和通胀**刺激消费（预期未来涨价）
- **降低实际工资**（可能促进就业）
- **调节经济**：价格信号作用

## 通货紧缩

物价持续下降，同样有害经济：
- 延迟消费（等待更低价格）
- 债务负担加重
- 企业利润下降

### 通胀目标

大多数央行将通胀目标设定在 **2%** 左右，兼顾稳定与增长。
    `,
    simple_explanation: '通胀就是钱"不值钱"了。以前100块能买一购物车的东西，现在只能买半车。通胀就像温水煮青蛙，温和的通胀大家能接受，但如果是恶性通胀，钱就变成废纸了。',
    examples: [
      '德国1923年恶性通胀——面包价格从几马克涨到几千亿马克',
      '日本"失去的20年"通货紧缩——物价不涨反跌',
      '委内瑞拉通胀——钱变成废纸，用物物交换',
      '中国90年代通胀——保值储蓄，抢购潮'
    ],
    category: 'macro',
    difficulty: 'intermediate',
    order: 5,
    related_charts: ['inflation-chart', 'money-supply']
  },
  {
    chapter_id: 'monetary-policy',
    title: '货币政策',
    description: '央行如何通过调节货币供应来影响经济',
    content: `
# 货币政策

## 什么是货币政策？

货币政策是中央银行通过控制和调节货币供应量，影响宏观经济运行的政策措施。

## 中央银行的职能

1. **发行的银行**：垄断货币发行权
2. **银行的银行**：最后贷款人
3. **政府的银行**：代理国库
4. **货币政策执行者**：调控货币供应

## 货币政策工具

### 1. 存款准备金率

商业银行必须将吸收存款的一定比例存入央行。

- **调高**：减少货币供应（紧缩性）
- **调低**：增加货币供应（扩张性）

### 2. 再贴现率

商业银行向央行借款的利率。

- **调高**：增加借款成本（紧缩性）
- **调低**：降低借款成本（扩张性）

### 3. 公开市场业务（最常用）

央行买卖国债：

- **买入国债**：投放货币（扩张性）
- **卖出国债**：回笼货币（紧缩性）

## 货币政策类型

### 扩张性货币政策

**目的**：刺激经济增长
- 降低利率
- 增加货币供应
- 适用：经济衰退、高失业

### 紧缩性货币政策

**目的**：抑制通货膨胀
- 提高利率
- 减少货币供应
- 适用：经济过热、高通胀

## 货币政策的局限性

1. **时间滞后**：政策效果需6-18个月显现
2. **不确定性**：经济预测困难
3. **全球经济影响**：国际资本流动
    `,
    simple_explanation: '央行就像经济的"总闸门"。经济冷了就放水（多印钱），经济热了就收水（少印钱）。但这个"水龙头"不能乱开，开大了会通胀，关小了会经济衰退。',
    examples: [
      '2008年金融危机——全球央行大放水救市',
      '美联储加息——抑制通胀，美元升值',
      '中国降准降息——刺激经济增长',
      '日本负利率政策——对抗通缩和经济停滞'
    ],
    category: 'macro',
    difficulty: 'advanced',
    order: 6,
    related_charts: ['money-supply', 'inflation-chart']
  },
  {
    chapter_id: 'time-value-money',
    title: '货币的时间价值',
    description: '理解今天的钱比明天的钱更值钱这一金融学核心概念',
    content: `
# 货币的时间价值

## 核心原理

**今天的 100 元 > 明天的 100 元**

原因：
1. **投资机会**：今天可以投资获得收益
2. **通胀因素**：货币购买力下降
3. **风险偏好**：未来的不确定性

## 复利计算

复利是指利息也能产生利息。

**公式**：
$$FV = PV \\times (1 + r)^n$$

- **FV**：未来值
- **PV**：现值
- **r**：利率
- **n**：期数

### 例：复利的威力

假设年化收益率 10%：
- 1 年后：110 元
- 10 年后：259 元
- 30 年后：1745 元

**爱因斯坦**："复利是世界第八大奇迹。"

## 贴现

贴现是将未来的钱折算成今天的价值。

$$PV = \\frac{FV}{(1 + r)^n}$$

### 例：选择奖金

选项 A：今天拿 100 万
选项 B：一年后拿 110 万

假设年化收益率 10%：
- A 的未来值 = 100 × (1 + 10%) = 110 万
- B 的现值 = 110 ÷ (1 + 10%) = 100 万

两个选项等值！

如果收益率 > 10%，选 A
如果收益率 < 10%，选 B

## 实际应用

### 贷款

房贷、车贷分期付款的计算本质上都是复利。

### 投资

股票、债券、基金的估值都基于时间价值。

### 退休规划

越早开始投资，复利效应越明显。
    `,
    simple_explanation: '钱生钱，钱生的钱再生钱。今天投资100元，一年后变成110元，两年后就是121元（复利）。时间越长，这个效果越惊人。所以投资要趁早。',
    examples: [
      '房贷30年——利息往往超过本金',
      '养老保险——越早交越划算',
      '信用卡分期——年化利率可能高达20%',
      '股票长期投资——年化8-10%很常见'
    ],
    category: 'finance',
    difficulty: 'beginner',
    order: 7,
    related_charts: ['price-equilibrium']
  },
  {
    chapter_id: 'risk-return',
    title: '风险与收益',
    description: '学习金融学基本定律：高收益伴随高风险',
    content: `
# 风险与收益

## 基本关系

**高风险 = 高预期收益**

但要注意：高风险不等于高实际收益！

## 风险的类型

### 系统性风险

整个市场都面临的风险，无法通过分散投资消除。

- 经济衰退
- 战争
- 利率变化
- 政策调整

### 非系统性风险

单个公司或行业特有的风险，可以通过分散投资降低。

- 管理层决策失误
- 行业技术变革
- 公司财务问题

## 分散投资

"不要把所有鸡蛋放在一个篮子里。"

通过持有多种资产，降低非系统性风险。

### 资产配置示例

| 资产类别 | 风险水平 | 预期收益 |
|---------|---------|---------|
| 现金 | 极低 | 0-2% |
| 国债 | 低 | 2-4% |
| 企业债 | 中 | 4-6% |
| 股票 | 高 | 8-12% |
| 衍生品 | 极高 | 不确定 |

## 风险度量

### 标准差

衡量收益率的波动程度。标准差越大，风险越大。

### 夏普比率

$$\\text{夏普比率} = \\frac{\\text{预期收益} - \\text{无风险利率}}{\\text{标准差}}$$

衡量单位风险的超额收益，越大越好。

## 投资者类型

### 保守型

- 首选保本
- 接受低收益
- 配置：存款、国债

### 平衡型

- 风险适中
- 收益稳健
- 配置：债券 + 股票组合

### 激进型

- 追求高收益
- 承受高风险
- 配置：股票、衍生品

关键是了解自己的**风险承受能力**。
    `,
    simple_explanation: '想赚钱就得冒风险。存银行最安全但利息低，买股票可能赚很多也可能亏光。关键是找到适合自己的风险水平——不要为了高收益冒自己承受不了的风险。',
    examples: [
      '股票暴跌50%——高风险的体现',
      '国债收益率低但稳定——低风险',
      '余额宝——低风险低收益的例子',
      'P2P暴雷——高收益变高风险亏损'
    ],
    category: 'finance',
    difficulty: 'intermediate',
    order: 8,
    related_charts: []
  }
]

export async function initData(kv: KVNamespace): Promise<void> {
  // 检查是否已初始化
  const existing = await kv.get('system:initialized')
  if (existing) {
    console.log('Data already initialized')
    return
  }

  console.log('Initializing data...')

  // 创建章节
  for (const chapter of initialChapters) {
    const id = crypto.randomUUID()
    const now = new Date().toISOString()
    const fullChapter = {
      id,
      created_at: now,
      updated_at: now,
      is_published: true,
      ...chapter
    }

    // 存储章节
    await kv.put(`chapter:${id}`, JSON.stringify(fullChapter))
    // 存储 chapter_id 映射
    await kv.put(`chapter_id:${chapter.chapter_id}`, id)
  }

  // 标记已初始化
  await kv.put('system:initialized', 'true')

  console.log('Data initialized successfully')
}
